#!/bin/bash
# Git pre-push hook for Nu Language Compiler
# This hook runs before git push to ensure code quality

set -e

echo "ğŸ” Running pre-push checks..."

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ Cargo not found. Please install Rust."
    exit 1
fi

# Run cargo fmt check
echo "ğŸ“ Checking code formatting..."
if ! cargo fmt -- --check; then
    echo ""
    echo "âŒ Code formatting check failed!"
    echo "ğŸ’¡ Run 'cargo fmt' to fix formatting issues."
    exit 1
fi
echo "âœ… Code formatting check passed"

# Run clippy
echo "ğŸ”§ Running clippy..."
if ! cargo clippy -- -D warnings; then
    echo ""
    echo "âŒ Clippy found issues!"
    echo "ğŸ’¡ Fix the warnings above before pushing."
    exit 1
fi
echo "âœ… Clippy check passed"

# Run tests (library tests only to avoid example errors)
echo "ğŸ§ª Running tests..."
if ! cargo test --lib --quiet; then
    echo ""
    echo "âŒ Tests failed!"
    echo "ğŸ’¡ Fix the failing tests before pushing."
    exit 1
fi
echo "âœ… All tests passed"

# Build release binaries
echo "ğŸ”¨ Building release binaries..."
if ! cargo build --release --bins --quiet; then
    echo ""
    echo "âŒ Build failed!"
    echo "ğŸ’¡ Fix the build errors before pushing."
    exit 1
fi
echo "âœ… Release build successful"

echo ""
echo "âœ… All pre-push checks passed! Proceeding with push..."
exit 0