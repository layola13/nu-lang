
# Nu语言编译器开发路线图总览

## 📋 项目信息

- **项目名称**: Nu (Neuro-Rust) 编译器
- **版本**: v1.3.1 (含工程系统补丁)
- **开发周期**: 约 4-6 周
- **技术栈**: Rust + syn + logos + toml

---

## 🎯 核心目标

1. **Nu → Rust 转换器**: 将高密度Nu代码转换为标准Rust代码
2. **Rust → Nu 压缩器**: 将现有Rust代码压缩为Nu格式
3. **工程构建系统**: 实现Nu.toml项目管理和nuc命令行工具
4. **模块系统**: 支持D/u/U模块声明和导入导出

---

## 📊 开发阶段总览

| 阶段 | 名称 | 预计时间 | 优先级 | 依赖 |
|------|------|----------|--------|------|
| 1 | 项目初始化 | 1-2天 | 🔴 高 | - |
| 2 | 词法分析器 | 2-3天 | 🔴 高 | 阶段1 |
| 3 | AST定义 | 2-3天 | 🔴 高 | - |
| 4 | 语法分析器 | 5-7天 | 🔴 高 | 阶段2,3 |
| 5 | 工程系统 | 3-4天 | 🟡 中 | 阶段1 |
| 6 | 模块系统 | 2-3天 | 🟡 中 | 阶段4,5 |
| 7 | Nu2Rust转换 | 3-4天 | 🔴 高 | 阶段4 |
| 8 | 代码生成器 | 2-3天 | 🔴 高 | 阶段7 |
| 9 | CLI工具 | 2-3天 | 🟡 中 | 阶段5,8 |
| 10 | 测试框架 | 3-5天 | 🔴 高 | 阶段8 |
| 11 | Rust2Nu | 4-5天 | 🟢 低 | 阶段8 |
| 12 | 文档完善 | 2-3天 | 🟡 中 | 所有 |
| 13 | 性能优化 | 持续 | 🟢 低 | 阶段10 |

---

## 🚀 快速开始路径 (MVP)

如果要快速验证可行性，推荐按以下顺序开发：

### Week 1: 核心编译链路
```
Day 1-2:  阶段1 (项目初始化)
Day 3-5:  阶段2 (词法分析器) - 先实现核心Token
Day 6-7:  阶段3 (AST定义) - 先定义基础节点
```

### Week 2-3: 解析与转换
```
Day 8-14:  阶段4 (语法分析器) - 重点！最复杂
Day 15-18: 阶段7 (Nu2Rust转换)
Day 19-21: 阶段8 (代码生成器)
```

### Week 4: 验证与完善
```
Day 22-26: 阶段10 (测试框架) - 编写完整测试用例
Day 27-28: 修复Bug，优化错误提示
```

### Week 5-6: 工程化与生态
```
Day 29-32: 阶段5 (工程系统)
Day 33-35: 阶段6 (模块系统)
Day 36-38: 阶段9 (CLI工具)
Day 39-42: 阶段11 (Rust2Nu) - 可选
```

---

## 🔑 关键技术难点

### 1. 运算符二义性消解 ⚠️
**难度**: ★★★★★

```nu
< val      // Return
a < b      // 比较运算符
```

**解决方案**: 
- 在Parser中使用位置上下文判断
- 语句开头的 `<` / `>` → Return/Print
- 表达式中间的 `<` / `>` → 比较运算符

### 2. `!` 前缀/后缀消歧 ⚠️
**难度**: ★★★★☆

```nu
&!self     // &mut self (前缀)
func()!    // func()? (后缀)
```

**解决方案**:
- Lexer记录Token位置
- Parser根据前后Token类型判断

### 3. 字符串插值解析 ⚠️
**难度**: ★★★☆☆

```nu
> "Value: {x}"  // println!("Value: {}", x)
```

**解决方案**:
- 自定义字符串解析器
- 提取 `{...}` 中的表达式
- 生成format_args!宏调用

### 4. 模块路径解析 ⚠️
**难度**: ★★★★☆

```nu
D Network   // pub mod network; (查找 network.nu)
u crate::utils::Auth
```

**解决方案**:
- 构建模块解析器
- 实现PascalCase → snake_case转换
- 文件系统扫描与路径映射

### 5. 泛型与生命周期 ⚠️
**难度**: ★★★☆☆

```nu
F Process<T> w T: Read + `a { }
```

**解决方案**:
- 直接复用syn的泛型解析
- 保持 `<T>` 和 `` `a `` 语法不变

---

## 📦 交付物清单

### 核心组件
- [x] Nu语言规范文档 (ReadMe.md)
- [x] 工程系统补丁 (patch.md)
- [x] 详细开发计划 (development_plan.md)
- [ ] 词法分析器 (lexer/)
- [ ] 语法分析器 (parser/)
- [ ] AST定义 (ast/)
- [ ] 代码生成器 (codegen/)
- [ ] 模块解析器 (module/)
- [ ] 工程系统 (project/)

### 工具链
- [ ] nuc CLI工具
  - [ ] nuc init (初始化项目)
  - [ ] nuc build (编译项目)
  - [ ] nuc run (运行项目)
  - [ ] nuc compress (Rust→Nu压缩)
  - [ ] nuc check (语法检查)

### 测试与文档
- [ ] 单元测试套件
- [ ] 集成测试
- [ ] 性能基准测试
- [ ] 用户手册
- [ ] API文档
- [ ] 示例项目集

---

## 🧪 测试策略

### 1. 单元测试
每个模块独立测试：
- Lexer: Token生成正确性
- Parser: AST构建正确性
- Codegen: Rust代码生成正确性

### 2. 集成测试
端到端测试：
```rust
#[test]
fn test_simple_function() {
    let nu_code = r#"
        F Add(a: i32, b: i32) -> i32 {
            < a + b
        }
    "#;
    
    let rust_code = compile_nu_to_rust(nu_code).unwrap();
    assert!(rust_code.contains("fn add(a: i32, b: i32) -> i32"));
    assert!(rust_code.contains("return a + b"));
}
```

### 3. 对比测试 (Golden Tests)
- 准备100个Rust代码示例
- 转换为Nu再转回Rust
- 比较语义等价性

### 4. 压缩率测试
- 统计Token数量
- 计算压缩比例
- 验证 ≥ 50% 目标

---

## 📈 里程碑

### M1: 最小可用原型 (MVP) - Week 3
**目标**: 能编译最简单的Nu程序

```nu
F Main() {
    > "Hello, Nu!";
}
```

**验收标准**:
- ✅ 能解析基本函数定义
- ✅ 能处理简单语句 (Print)
- ✅ 生成可编译的Rust代码
- ✅ 手动测试通过

### M2: 核心特性完整 - Week 4
**目标**: 支持70%的Nu语法

- ✅ 所有定义关键字 (S/E/F/TR/I)
- ✅ 流控制 (?/M/L)
- ✅ 异步并发 (~/@/@@)
- ✅ 类型系统 (V/O/R/A/X/B)
- ✅ 错误处理 (!)
- ✅ 自动化测试覆盖率 > 80%

### M3: 工程化就绪 - Week 5
**目标**: 可管理真实项目

- ✅ Nu.toml支持
- ✅ 模块系统 (D/u/U)
- ✅ nuc CLI工具
- ✅ 能编译多文件项目
- ✅ 示例项目运行成功

### M4: 生产就绪 - Week 6
**目标**: 可用于实际开发

- ✅ 完整特性集实现
- ✅ Rust2Nu压缩工具
- ✅ 详细错误提示
- ✅ 性能优化完成
- ✅ 文档齐全
- ✅ 通过大规模测试

---

## 🎓 学习资源

### 必读文档
1. [syn官方文档](https://docs.rs/syn)
2. [logos教程](https://docs.rs/logos)
3. [Rust宏小册](https://danielkeep.github.io/tlborm/book/)
4. [编译原理 - 龙书](https://www.amazon.com/Compilers-Principles-Techniques-Tools-2nd/dp/0321486811)

### 参考项目
1. **rust-analyzer**: 学习Rust语法解析
2. **rustfmt**: 学习代码格式化
3. **cargo**: 学习项目管理
4. **swc**: 学习高性能Transpiler

---

## 🐛 风险与挑战

### 高风险项
1. **二义性解析**: `<` / `>` / `!` 的消歧可能比预期复杂
   - 缓解: 先实现严格的上下文规则，后续可放宽
   
2. **syn库限制**: 可能无法完全定制解析逻辑
   - 缓解: 必要时混用 chumsky 或手写Parser

3. **错误恢复**: 语法错误时如何提供友好提示
   - 缓解: 第一版先 panic，后续增强

### 中风险项
1. **性能**: 大型项目编译速度
   - 缓解: 后期优化，先保证正确性

2. **生态兼容**: Nu.toml ↔ Cargo.toml转换覆盖度
   - 缓解: 先支持常用字段，逐步扩展

---

## 🤝 协作建议

如果是团队开发：

### 角色分工
- **前端工程师**: Lexer + Parser (2人)
- **后端工程师**: Codegen + 工程系统 (1人)
- **工具开发**: CLI + Rust2Nu (1人)
- **测试工程师**: 测试框架 + QA (1人)

### 并行任务
可以同时进行：
- 