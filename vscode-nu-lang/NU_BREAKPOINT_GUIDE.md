# Nu 断点使用指南

## 🎯 功能简介

Nu Language v0.0.5 引入了**自动断点映射**功能，让您可以直接在 Nu 源文件中设置断点，插件会自动将断点映射到对应的 Rust 代码行。

## ✨ 核心特性

- ✅ **在 Nu 文件中直接设置断点** - 无需切换到 Rust 文件
- ✅ **自动映射到 Rust 代码** - 使用 SourceMap 精确定位
- ✅ **实时同步** - 添加、删除、修改断点自动同步
- ✅ **可视化反馈** - 显示映射结果的通知消息

## 📋 使用步骤

### 1. 准备工作

#### 安装调试器扩展

确保安装以下任一调试器扩展：
- [CodeLLDB](https://marketplace.visualstudio.com/items?itemName=vadimcn.vscode-lldb)（推荐）
- [C/C++](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools)

#### 生成 SourceMap

确保您的 Nu 文件已编译并生成了 SourceMap：

```bash
# 方法 1：在 VSCode 中保存 .nu 文件（如果启用了自动编译）
# 会自动生成 .rs 和 .rs.map 文件

# 方法 2：手动编译
nu2rust hello.nu -o hello.rs --sourcemap
```

生成的文件：
- `hello.rs` - 转换后的 Rust 代码
- `hello.rs.map` - SourceMap 映射文件

### 2. 设置断点

#### 在 Nu 文件中设置断点

1. 打开您的 `.nu` 文件（例如 `hello.nu`）
2. 点击行号左侧的空白区域
3. 出现红色圆点即为断点

```nu
f main() {
    println!("Hello");        // ← 点击这里设置断点
    l x = 42;                 // ← 或这里
    println!("x = {}", x);
}
```

#### 自动映射

插件会自动：
1. 检测到您在 Nu 文件设置了断点
2. 加载对应的 SourceMap（`hello.rs.map`）
3. 查找 Nu 行号对应的 Rust 行号
4. 在 Rust 文件中自动设置对应的断点
5. 显示通知：`Nu breakpoint at line 3 → Rust line 5`

### 3. 启动调试

按 **F5** 或点击调试面板的"开始调试"按钮：

1. 插件会自动编译带调试信息的二进制文件
2. 启动调试器（LLDB/GDB）
3. 程序会在您设置的断点处停止

### 4. 调试操作

程序停在断点后，您可以：

| 操作 | 快捷键 | 说明 |
|------|--------|------|
| 继续执行 | F5 | 运行到下一个断点 |
| 单步跳过 | F10 | 执行当前行 |
| 单步进入 | F11 | 进入函数内部 |
| 单步跳出 | Shift+F11 | 跳出当前函数 |
| 停止调试 | Shift+F5 | 结束调试会话 |

## 🔍 工作原理

### 断点映射流程

```
┌──────────────────────────────────────────────────────┐
│ 1. 用户在 Nu 文件设置断点                              │
│    hello.nu:3 (println!("Hello"))                     │
└──────────────┬───────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────┐
│ 2. BreakpointTranslator 监听断点变化事件               │
│    vscode.debug.onDidChangeBreakpoints()              │
└──────────────┬───────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────┐
│ 3. 加载 SourceMap                                     │
│    sourcemapService.loadSourceMap('hello.rs.map')     │
└──────────────┬───────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────┐
│ 4. 映射 Nu 行号 → Rust 行号                          │
│    mapping = mapNuToRust(mapPath, 3, 0)              │
│    result: { rsLine: 5, rsColumn: 0 }                │
└──────────────┬───────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────┐
│ 5. 在 Rust 文件中自动设置断点                         │
│    vscode.debug.addBreakpoints([rustBreakpoint])      │
│    hello.rs:5                                         │
└──────────────┬───────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────┐
│ 6. 调试器在 Rust 断点处停止                           │
│    LLDB/GDB stops at hello.rs:5                       │
└──────────────────────────────────────────────────────┘
```

### SourceMap 格式

```json
{
  "version": "1.0",
  "file": "hello.rs",
  "nu_file": "hello.nu",
  "mappings": [
    {
      "nuLine": 3,
      "nuColumn": 0,
      "rsLine": 5,
      "rsColumn": 4,
      "name": "println"
    }
  ]
}
```

## 📊 示例场景

### 场景 1：调试函数调用

**Nu 代码（hello.nu）：**
```nu
F add(a: i32, b: i32) -> i32 {
    a + b                     // ← 设置断点
}

f main() {
    l result = add(2, 3);     // ← 设置断点
    println!("{}", result);
}
```

**操作步骤：**
1. 在第 2 行和第 6 行设置断点
2. 按 F5 启动调试
3. 程序停在第 6 行（main 函数调用 add）
4. 按 F11 单步进入 add 函数
5. 程序停在第 2 行（a + b）
6. 按 F10 执行加法
7. 查看 Variables 面板中的变量值

### 场景 2：调试循环

**Nu 代码（loop.nu）：**
```nu
f main() {
    for i in 0..5 {
        println!("{}", i);    // ← 设置断点
    }
}
```

**操作步骤：**
1. 在第 3 行设置断点
2. 按 F5 启动调试
3. 程序在每次循环迭代时都会停在断点
4. 观察变量 `i` 的值变化
5. 按 F5 继续到下一次迭代

### 场景 3：调试条件分支

**Nu 代码（条件.nu）：**
```nu
f main() {
    l x = 10;
    
    if x > 5 {
        println!("大于5");    // ← 设置断点
    } else {
        println!("小于等于5"); // ← 设置断点
    }
}
```

**操作步骤：**
1. 在第 5 行和第 7 行都设置断点
2. 按 F5 启动调试
3. 由于 x=10，程序停在第 5 行（true 分支）
4. 不会执行第 7 行

## 🔧 故障排除

### 问题 1：断点没有映射

**症状：**
- 在 Nu 文件设置断点后，没有收到映射通知
- 调试时断点不生效

**可能原因：**
1. SourceMap 文件不存在（`.rs.map`）
2. SourceMap 文件过期（Nu 代码已修改但未重新编译）
3. Nu 行号在 SourceMap 中没有对应的映射

**解决方案：**
```bash
# 重新生成 SourceMap
nu2rust hello.nu -o hello.rs --sourcemap -f

# 检查 SourceMap 是否存在
ls -la hello.rs.map

# 查看 SourceMap 内容
cat hello.rs.map
```

### 问题 2：映射的行号不正确

**症状：**
- 收到映射通知，但行号看起来不对
- 调试时停在错误的位置

**可能原因：**
1. SourceMap 文件过期
2. Rust 代码已被手动修改
3. SourceMap 生成时出错

**解决方案：**
1. 删除旧的 `.rs` 和 `.rs.map` 文件
2. 重新编译：`nu2rust hello.nu -o hello.rs --sourcemap -f`
3. 不要手动修改生成的 Rust 代码

### 问题 3：断点映射后无法移除

**症状：**
- 在 Nu 文件中删除断点
- Rust 文件中的对应断点仍然存在

**解决方案：**
1. 重新加载 VSCode 窗口（Ctrl+Shift+P → "Reload Window"）
2. 手动删除 Rust 文件中的断点
3. 重启调试会话

### 问题 4：调试器找不到源文件

**症状：**
- 调试器启动，但显示"无法打开源文件"
- 或打开符号文件 `@___lldb_unnamed_symbol`

**解决方案：**
1. 确保 `.rs` 文件与二进制文件在同一目录
2. 检查文件路径是否正确
3. 在 Rust 文件中手动设置断点作为替代方案

## 💡 最佳实践

### 1. 保持 SourceMap 最新

每次修改 Nu 代码后，确保重新编译：
- 启用自动编译（默认开启）
- 或手动保存文件触发编译
- 或运行 `nu2rust` 命令

### 2. 使用有意义的断点

在关键逻辑处设置断点：
- ✅ 函数入口
- ✅ 条件分支
- ✅ 循环内部
- ✅ 变量赋值
- ❌ 空行或注释行

### 3. 结合其他调试功能

- **监视表达式** - 添加变量到 Watch 面板
- **调用栈** - 查看函数调用链
- **条件断点** - 只在特定条件下停止

### 4. 理解映射限制

当前 SourceMap 是基于行号的简化版本：
- ✅ 可以精确映射函数、结构体等主要定义
- ⚠️ 行内多个表达式可能映射到同一行
- ⚠️ 宏展开的代码难以精确映射

## 🚀 未来改进

### 计划中的功能

1. **AST 级别的 SourceMap**
   - 表达式级别的精确映射
   - 支持列号映射
   - 更准确的断点位置

2. **条件断点映射**
   - 在 Nu 文件中设置条件断点
   - 自动转换为 Rust 条件断点

3. **日志点（Logpoint）支持**
   - 在断点处打印日志而不停止
   - 自动映射日志点到 Rust 代码

4. **断点验证**
   - 检测无效的断点位置
   - 提供建议的替代位置

## 📚 相关文档

- [DEBUG_SYNC_GUIDE.md](./DEBUG_SYNC_GUIDE.md) - 调试同步功能指南
- [SOURCEMAP_IMPLEMENTATION.md](./SOURCEMAP_IMPLEMENTATION.md) - SourceMap 实现细节
- [DEBUG_GUIDE.md](./DEBUG_GUIDE.md) - 完整调试指南
- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - 故障排除

## 🎉 总结

有了 Nu 断点自动映射功能，您现在可以：

1. ✅ 在熟悉的 Nu 代码中设置断点
2. ✅ 无需手动查找对应的 Rust 代码
3. ✅ 享受无缝的调试体验
4. ✅ 专注于解决问题而非工具使用

开始使用 Nu 断点功能，让调试变得更简单！🚀